import sqlite3, json
def get_but_stats_and_total(league, team, side, interval):
    # Normalisation du nom d'équipe avant requête
    def normalize_team_name(name):
        return name.strip().lower().replace('.', '').replace('-', ' ').replace("'", '').replace('  ', ' ')
    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
    cursor = conn.cursor()
    cursor.execute("SELECT DISTINCT team FROM soccerstats_scraped_matches WHERE league = ?", (league,))
    teams_in_db = [row[0] for row in cursor.fetchall()]
    norm_map = {normalize_team_name(t): t for t in teams_in_db}
    team_norm = normalize_team_name(team)
    team_db = norm_map.get(team_norm, None)
    cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (league, team_db or team))
    matchs = cursor.fetchall()
    conn.close()
    buts_marques, buts_encaisses = 0, 0
    total_matches = 0
    for goal_times, goal_times_conceded, is_home in matchs:
        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
            continue
        total_matches += 1
        try:
            goals = json.loads(goal_times) if goal_times else []
            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
        except Exception:
            goals, conceded = [], []
        start, end = interval
        buts_marques += sum(1 for m in goals if start <= m <= end)
        buts_encaisses += sum(1 for m in conceded if start <= m <= end)
    return buts_marques, buts_encaisses, buts_marques + buts_encaisses, total_matches
# Fonction de normalisation des noms d'équipes
def normalize_team_name(name):
    return name.strip().lower().replace('.', '').replace('-', ' ').replace("'", '').replace('  ', ' ')

# Fonction pour calculer le nombre moyen de buts par mi-temps (MT1 et MT2)
def compute_mt_goals(matchs):
    mt1_buts_list = []
    mt2_buts_list = []
    for goal_times, goal_times_conceded, is_home in matchs:
        try:
            goals = __import__('json').loads(goal_times) if goal_times else []
            conceded = __import__('json').loads(goal_times_conceded) if goal_times_conceded else []
        except Exception:
            goals, conceded = [], []
        # MT1 = 1 à 45+ (on prend tout <= 45.99)
        mt1_buts = sum(1 for m in goals + conceded if 1 <= m <= 45.99)
        # MT2 = 46 à 90+ (on prend tout >= 46)
        mt2_buts = sum(1 for m in goals + conceded if 46 <= m <= 120)
        mt1_buts_list.append(mt1_buts)
        mt2_buts_list.append(mt2_buts)
    def safe_mean(l):
        return sum(l)/len(l) if l else 0.0
    def safe_sem(l):
        n = len(l)
        if n <= 1:
            # Bloc gestion live désactivé pour permettre la simulation uniquement
            # (voir la fin du script pour la simulation d'affichage)
                print(f"Erreur chargement {league_url}: {e}")
            continue
        # Regex pour lignes de match live: minute, équipes, score
        # Ex: 90'+4\s+Nacional Potosi\s+2:0\s+ABB
        pattern = re.compile(r"(\d{1,3}'\+?\d{0,2})\s+([A-Za-z .'-]+)\s+(\d+:\d+)\s+([A-Za-z .'-]+)")
        for m in pattern.finditer(page):
            minute = m.group(1)
            home = m.group(2).strip()
            score = m.group(3)
            away = m.group(4).strip()
            snippet = f"{minute} {home} {score} {away}"
            # Construction de l'URL stats
            # On cherche le lien pmatch correspondant
            soup = BeautifulSoup(page, "html.parser")
            match_url = None
            for a in soup.find_all("a", href=True):
                if "pmatch" in a["href"] and home in a.get("title", "") and away in a.get("title", ""):
                    match_url = urljoin(league_url, a["href"])
                    break
            results.append({
                "url": match_url if match_url else league_url,
                "minute": minute,
                "home_team": home,
                "away_team": away,
                "score": score,
                "snippet": snippet,
                "league": lid
            })
    # Tri par minute (live d'abord)
        def minute_sort_key(x):
            m = re.match(r"(\d{1,3})", x.get("minute", ""))
            return int(m.group(1)) if m else -1
        results.sort(key=minute_sort_key, reverse=True)
        return results
    # ...existing code...


def monitor_match(url: str, interval: int = 10):
    """Boucle simple qui récupère les infos du match à intervalle régulier.

    Si `SoccerStatsLiveScraper` est disponible, on l'utilise pour des données complètes.
    """
    if SoccerStatsLiveScraper is None:
        print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
        return

    scraper = SoccerStatsLiveScraper()
    try:
        while True:
            try:
                data = scraper.scrape_match(url)
            except Exception as e:
                print(f"Erreur scraping: {e}")
                data = None

            if data:
                d = data.to_dict() if hasattr(data, "to_dict") else data
                minute = d.get("minute")
                score = f"{d.get('home_score')}:{d.get('away_score')}" if d.get('home_score') is not None else "-"
                teams = f"{d.get('home_team')} vs {d.get('away_team')}"
                print(f"[{time.strftime('%H:%M:%S')}] {teams} | {score} | {minute} min")
            else:
                print(f"[{time.strftime('%H:%M:%S')}] Pas de données pour {url}")

            time.sleep(interval)
    except KeyboardInterrupt:
        print("Monitor stoppé par l'utilisateur.")


def get_pattern_score_details(league, team, side, interval):
    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
    import sqlite3, json
    # Normalisation du nom d'équipe avant requête
    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
    cursor = conn.cursor()
    cursor.execute("SELECT DISTINCT team FROM soccerstats_scraped_matches WHERE league = ?", (league,))
    teams_in_db = [row[0] for row in cursor.fetchall()]
    norm_map = {normalize_team_name(t): t for t in teams_in_db}
    team_norm = normalize_team_name(team)
    team_db = norm_map.get(team_norm, None)
    if not team_db:
        pass
    cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (league, team_db or team))
    matchs = cursor.fetchall()
    conn.close()
    # Filtrage par side
    filtered = []
    for goal_times, goal_times_conceded, is_home in matchs:
        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
            continue
        filtered.append((goal_times, goal_times_conceded))
    total = len(filtered)
    start, end = interval
    # Récurrence globale
    avec_but = 0
    for goal_times, goal_times_conceded in filtered:
        try:
            goals = json.loads(goal_times) if goal_times else []
            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
        except Exception:
            goals, conceded = [], []
        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
        if len(buts_dans_intervalle) > 0:
            avec_but += 1
    recurrence_globale = (avec_but / total) if total > 0 else 0.0
    # Récurrence récente (fenêtres 3,4,5)
    best_recent = 0.0
    best_window = 3
    for window in [3,4,5]:
        if total >= window:
            recent = filtered[-window:]
            avec_but_recent = 0
            for goal_times, goal_times_conceded in recent:
                try:
                    goals = json.loads(goal_times) if goal_times else []
                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                except Exception:
                    goals, conceded = [], []
                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                if len(buts_dans_intervalle) > 0:
                    avec_but_recent += 1
            rec = avec_but_recent / window
            if rec > best_recent:
                best_recent = rec
                best_window = window
    # Score combiné
    if total >= 3:
        score = (recurrence_globale + best_recent) / 2
    else:
        score = recurrence_globale

    if args.monitor:
        monitor_match(args.monitor, interval=args.interval)
    elif args.all_live_details:
        if SoccerStatsLiveScraper is None:
            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
        else:
            lives = get_live_matches(args.url, debug=args.debug)
            # print(f"[DEBUG] Lives détectés : {lives}")
            if not lives:
                print("Aucun match live détecté depuis la page principale.")
            else:
                print("\nDétails complets pour tous les matches live détectés :\n")
                scraper = SoccerStatsLiveScraper()
                from scoring_detaille import scoring_detaille
                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                # Historique in-play pour momentum (clé: match_url)
                stats_history = {}
                for m in lives:
                    # print(f"[DEBUG] Traitement match : {m}")
                    try:
                        data = scraper.scrape_match(m['url'])
                        if data:
                            d = data.to_dict() if hasattr(data, "to_dict") else data
                            # Initialisation de l'intervalle AVANT toute utilisation
                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                            # (on doit recharger les matchs pour chaque équipe)
                            import sqlite3
                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                            cursor = conn.cursor()
                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                            conn.close()
                            mt_stats_home = compute_mt_goals(matchs_home)
                            mt_stats_away = compute_mt_goals(matchs_away)
                            if interval == (31, 45):
                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                            else:
                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                        else:
                            moyenne_attendue = 1
                    except Exception as e:
                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                        moyenne_attendue = 1
                    print("\n================ LIVE MATCH =================")
                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                    # Bloc try/except supprimé pour corriger l'erreur de syntaxe
                            def get_but_stats(league, team, side, interval):
                                def get_pattern_score_details(league, team, side, interval):
                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                    import sqlite3, json
                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                    cursor = conn.cursor()
                                    cursor.execute(
                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                        (league, team)
                                    )
                                    matchs = cursor.fetchall()
                                    conn.close()
                                    # Filtrage par side
                                    filtered = []
                                    for goal_times, goal_times_conceded, is_home in matchs:
                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                            continue
                                        filtered.append((goal_times, goal_times_conceded))
                                    total = len(filtered)
                                    start, end = interval
                                    # Récurrence globale
                                    avec_but = 0
                                    for goal_times, goal_times_conceded in filtered:
                                        try:
                                            goals = json.loads(goal_times) if goal_times else []
                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                        except Exception:
                                            goals, conceded = [], []
                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                        if len(buts_dans_intervalle) > 0:
                                            avec_but += 1
                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                    # Récurrence récente (fenêtres 3,4,5)
                                    best_recent = 0.0
                                    best_window = 3
                                    for window in [3,4,5]:
                                        if total >= window:
                                            recent = filtered[-window:]
                                            avec_but_recent = 0
                                            for goal_times, goal_times_conceded in recent:
                                                try:
                                                    goals = json.loads(goal_times) if goal_times else []
                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                except Exception:
                                                    goals, conceded = [], []
                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                if len(buts_dans_intervalle) > 0:
                                                    avec_but_recent += 1
                                            rec = avec_but_recent / window
                                            if rec > best_recent:
                                                best_recent = rec
                                                best_window = window
                                    # Score combiné
                                    if total >= 3:
                                        score = (recurrence_globale + best_recent) / 2
                                    else:
                                        score = recurrence_globale

                                    if args.monitor:
                                        monitor_match(args.monitor, interval=args.interval)
                                    elif args.all_live_details:
                                        if SoccerStatsLiveScraper is None:
                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                        else:
                                            lives = get_live_matches(args.url, debug=args.debug)
                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                            if not lives:
                                                print("Aucun match live détecté depuis la page principale.")
                                            else:
                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                scraper = SoccerStatsLiveScraper()
                                                from scoring_detaille import scoring_detaille
                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                # Historique in-play pour momentum (clé: match_url)
                                                stats_history = {}
                                                for m in lives:
                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                    try:
                                                        data = scraper.scrape_match(m['url'])
                                                        if data:
                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                            # (on doit recharger les matchs pour chaque équipe)
                                                            import sqlite3
                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                            cursor = conn.cursor()
                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                            conn.close()
                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                            if interval == (31, 45):
                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                            else:
                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                        else:
                                                            moyenne_attendue = 1
                                                    except Exception as e:
                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                        moyenne_attendue = 1
                                                    print("\n================ LIVE MATCH =================")
                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                    try:
                                                        data = scraper.scrape_match(m['url'])
                                                        if data:
                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                            print("--- PATTERNS HISTORIQUES ---")
                                                            from scoring_utils import get_pattern_score
                                                            # interval déjà défini plus haut
                                                            def get_but_stats(league, team, side, interval):
                                                                def get_pattern_score_details(league, team, side, interval):
                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                    import sqlite3, json
                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                    cursor = conn.cursor()
                                                                    cursor.execute(
                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                        (league, team)
                                                                    )
                                                                    matchs = cursor.fetchall()
                                                                    conn.close()
                                                                    # Filtrage par side
                                                                    filtered = []
                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                            continue
                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                    total = len(filtered)
                                                                    start, end = interval
                                                                    # Récurrence globale
                                                                    avec_but = 0
                                                                    for goal_times, goal_times_conceded in filtered:
                                                                        try:
                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                        except Exception:
                                                                            goals, conceded = [], []
                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                        if len(buts_dans_intervalle) > 0:
                                                                            avec_but += 1
                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                    best_recent = 0.0
                                                                    best_window = 3
                                                                    for window in [3,4,5]:
                                                                        if total >= window:
                                                                            recent = filtered[-window:]
                                                                            avec_but_recent = 0
                                                                            for goal_times, goal_times_conceded in recent:
                                                                                try:
                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                except Exception:
                                                                                    goals, conceded = [], []
                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                if len(buts_dans_intervalle) > 0:
                                                                                    avec_but_recent += 1
                                                                            rec = avec_but_recent / window
                                                                            if rec > best_recent:
                                                                                best_recent = rec
                                                                                best_window = window
                                                                    # Score combiné
                                                                    if total >= 3:
                                                                        score = (recurrence_globale + best_recent) / 2
                                                                    else:
                                                                        score = recurrence_globale

                                                                    if args.monitor:
                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                    elif args.all_live_details:
                                                                        if SoccerStatsLiveScraper is None:
                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                        else:
                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                            if not lives:
                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                            else:
                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                scraper = SoccerStatsLiveScraper()
                                                                                from scoring_detaille import scoring_detaille
                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                stats_history = {}
                                                                                for m in lives:
                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                    try:
                                                                                        data = scraper.scrape_match(m['url'])
                                                                                        if data:
                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                            import sqlite3
                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                            cursor = conn.cursor()
                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                            conn.close()
                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                            if interval == (31, 45):
                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                            else:
                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                        else:
                                                                                            moyenne_attendue = 1
                                                                                    except Exception as e:
                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                        moyenne_attendue = 1
                                                                                    print("\n================ LIVE MATCH =================")
                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                    try:
                                                                                        data = scraper.scrape_match(m['url'])
                                                                                        if data:
                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                            from scoring_utils import get_pattern_score
                                                                                            # interval déjà défini plus haut
                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                    import sqlite3, json
                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                    cursor = conn.cursor()
                                                                                                    cursor.execute(
                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                        (league, team)
                                                                                                    )
                                                                                                    matchs = cursor.fetchall()
                                                                                                    conn.close()
                                                                                                    # Filtrage par side
                                                                                                    filtered = []
                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                            continue
                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                    total = len(filtered)
                                                                                                    start, end = interval
                                                                                                    # Récurrence globale
                                                                                                    avec_but = 0
                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                        try:
                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                        except Exception:
                                                                                                            goals, conceded = [], []
                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                            avec_but += 1
                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                    best_recent = 0.0
                                                                                                    best_window = 3
                                                                                                    for window in [3,4,5]:
                                                                                                        if total >= window:
                                                                                                            recent = filtered[-window:]
                                                                                                            avec_but_recent = 0
                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                try:
                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                except Exception:
                                                                                                                    goals, conceded = [], []
                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                    avec_but_recent += 1
                                                                                                            rec = avec_but_recent / window
                                                                                                            if rec > best_recent:
                                                                                                                best_recent = rec
                                                                                                                best_window = window
                                                                                                    # Score combiné
                                                                                                    if total >= 3:
                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                    else:
                                                                                                        score = recurrence_globale

                                                                                                    if args.monitor:
                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                    elif args.all_live_details:
                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                        else:
                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                            if not lives:
                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                            else:
                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                stats_history = {}
                                                                                                                for m in lives:
                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                    try:
                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                        if data:
                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                            import sqlite3
                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                            cursor = conn.cursor()
                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                            conn.close()
                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                            if interval == (31, 45):
                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                            else:
                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                        else:
                                                                                                                            moyenne_attendue = 1
                                                                                                                    except Exception as e:
                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                        moyenne_attendue = 1
                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                    try:
                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                        if data:
                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                            # interval déjà défini plus haut
                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                    import sqlite3, json
                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                    cursor = conn.cursor()
                                                                                                                                    cursor.execute(
                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                        (league, team)
                                                                                                                                    )
                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                    conn.close()
                                                                                                                                    # Filtrage par side
                                                                                                                                    filtered = []
                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                            continue
                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                    total = len(filtered)
                                                                                                                                    start, end = interval
                                                                                                                                    # Récurrence globale
                                                                                                                                    avec_but = 0
                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                        try:
                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                        except Exception:
                                                                                                                                            goals, conceded = [], []
                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                            avec_but += 1
                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                    best_recent = 0.0
                                                                                                                                    best_window = 3
                                                                                                                                    for window in [3,4,5]:
                                                                                                                                        if total >= window:
                                                                                                                                            recent = filtered[-window:]
                                                                                                                                            avec_but_recent = 0
                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                try:
                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                except Exception:
                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                    avec_but_recent += 1
                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                            if rec > best_recent:
                                                                                                                                                best_recent = rec
                                                                                                                                                best_window = window
                                                                                                                                    # Score combiné
                                                                                                                                    if total >= 3:
                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                    else:
                                                                                                                                        score = recurrence_globale

                                                                                                                                    if args.monitor:
                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                    elif args.all_live_details:
                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                        else:
                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                            if not lives:
                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                            else:
                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                stats_history = {}
                                                                                                                                                for m in lives:
                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                    try:
                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                        if data:
                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                            import sqlite3
                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                            conn.close()
                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                            else:
                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                        else:
                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                    except Exception as e:
                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                    try:
                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                        if data:
                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                    cursor.execute(
                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                                                        (league, team)
                                                                                                                                                                    )
                                                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                                                    conn.close()
                                                                                                                                                                    # Filtrage par side
                                                                                                                                                                    filtered = []
                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                                                            continue
                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                                                    total = len(filtered)
                                                                                                                                                                    start, end = interval
                                                                                                                                                                    # Récurrence globale
                                                                                                                                                                    avec_but = 0
                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                                                        try:
                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                        except Exception:
                                                                                                                                                                            goals, conceded = [], []
                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                                                            avec_but += 1
                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                                                    best_recent = 0.0
                                                                                                                                                                    best_window = 3
                                                                                                                                                                    for window in [3,4,5]:
                                                                                                                                                                        if total >= window:
                                                                                                                                                                            recent = filtered[-window:]
                                                                                                                                                                            avec_but_recent = 0
                                                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                                                try:
                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                except Exception:
                                                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                    avec_but_recent += 1
                                                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                                                            if rec > best_recent:
                                                                                                                                                                                best_recent = rec
                                                                                                                                                                                best_window = window
                                                                                                                                                                    # Score combiné
                                                                                                                                                                    if total >= 3:
                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                                                    else:
                                                                                                                                                                        score = recurrence_globale

                                                                                                                                                                    if args.monitor:
                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                                                    elif args.all_live_details:
                                                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                                                        else:
                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                                                            if not lives:
                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                                                            else:
                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                                                stats_history = {}
                                                                                                                                                                                for m in lives:
                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                                                    try:
                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                        if data:
                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                                                            import sqlite3
                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                                                            conn.close()
                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                                                            else:
                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                                                        else:
                                                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                                                    try:
                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                        if data:
                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                                                    cursor.execute(
                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                                                                                        (league, team)
                                                                                                                                                                                                    )
                                                                                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                                                                                    conn.close()
                                                                                                                                                                                                    # Filtrage par side
                                                                                                                                                                                                    filtered = []
                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                                                                                            continue
                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                                                                                    total = len(filtered)
                                                                                                                                                                                                    start, end = interval
                                                                                                                                                                                                    # Récurrence globale
                                                                                                                                                                                                    avec_but = 0
                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                                                                                        try:
                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                        except Exception:
                                                                                                                                                                                                            goals, conceded = [], []
                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                            avec_but += 1
                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                                                                                    best_recent = 0.0
                                                                                                                                                                                                    best_window = 3
                                                                                                                                                                                                    for window in [3,4,5]:
                                                                                                                                                                                                        if total >= window:
                                                                                                                                                                                                            recent = filtered[-window:]
                                                                                                                                                                                                            avec_but_recent = 0
                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                                                                                try:
                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                except Exception:
                                                                                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                    avec_but_recent += 1
                                                                                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                                                                                            if rec > best_recent:
                                                                                                                                                                                                                best_recent = rec
                                                                                                                                                                                                                best_window = window
                                                                                                                                                                                                    # Score combiné
                                                                                                                                                                                                    if total >= 3:
                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                                                                                    else:
                                                                                                                                                                                                        score = recurrence_globale

                                                                                                                                                                                                    if args.monitor:
                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                                                                                    elif args.all_live_details:
                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                                                                                        else:
                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                                                                                            if not lives:
                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                                                                                            else:
                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                                                                                stats_history = {}
                                                                                                                                                                                                                for m in lives:
                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                                                                                            import sqlite3
                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                                                                                            conn.close()
                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                                                                                    cursor.execute(
                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                                                                                                                        (league, team)
                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                                                                                                                    conn.close()
                                                                                                                                                                                                                                    # Filtrage par side
                                                                                                                                                                                                                                    filtered = []
                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                                                                                                                    total = len(filtered)
                                                                                                                                                                                                                                    start, end = interval
                                                                                                                                                                                                                                    # Récurrence globale
                                                                                                                                                                                                                                    avec_but = 0
                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                        except Exception:
                                                                                                                                                                                                                                            goals, conceded = [], []
                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                            avec_but += 1
                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                                                                                                                    best_recent = 0.0
                                                                                                                                                                                                                                    best_window = 3
                                                                                                                                                                                                                                    for window in [3,4,5]:
                                                                                                                                                                                                                                        if total >= window:
                                                                                                                                                                                                                                            recent = filtered[-window:]
                                                                                                                                                                                                                                            avec_but_recent = 0
                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                except Exception:
                                                                                                                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                    avec_but_recent += 1
                                                                                                                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                                                                                                                            if rec > best_recent:
                                                                                                                                                                                                                                                best_recent = rec
                                                                                                                                                                                                                                                best_window = window
                                                                                                                                                                                                                                    # Score combiné
                                                                                                                                                                                                                                    if total >= 3:
                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                        score = recurrence_globale

                                                                                                                                                                                                                                    if args.monitor:
                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                                                                                                                    elif args.all_live_details:
                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                                                                                                                            if not lives:
                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                                                                                                                stats_history = {}
                                                                                                                                                                                                                                                for m in lives:
                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                                                                                                                            import sqlite3
                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                                                                                                                            conn.close()
                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                                                                                                                    cursor.execute(
                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                                                                                                                                                        (league, team)
                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                                                                                                                                                    conn.close()
                                                                                                                                                                                                                                                                    # Filtrage par side
                                                                                                                                                                                                                                                                    filtered = []
                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                                                                                                                                                    total = len(filtered)
                                                                                                                                                                                                                                                                    start, end = interval
                                                                                                                                                                                                                                                                    # Récurrence globale
                                                                                                                                                                                                                                                                    avec_but = 0
                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                                        except Exception:
                                                                                                                                                                                                                                                                            goals, conceded = [], []
                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                                            avec_but += 1
                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                                                                                                                                                    best_recent = 0.0
                                                                                                                                                                                                                                                                    best_window = 3
                                                                                                                                                                                                                                                                    for window in [3,4,5]:
                                                                                                                                                                                                                                                                        if total >= window:
                                                                                                                                                                                                                                                                            recent = filtered[-window:]
                                                                                                                                                                                                                                                                            avec_but_recent = 0
                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                                                except Exception:
                                                                                                                                                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                                                    avec_but_recent += 1
                                                                                                                                                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                                                                                                                                                            if rec > best_recent:
                                                                                                                                                                                                                                                                                best_recent = rec
                                                                                                                                                                                                                                                                                best_window = window
                                                                                                                                                                                                                                                                    # Score combiné
                                                                                                                                                                                                                                                                    if total >= 3:
                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                        score = recurrence_globale

                                                                                                                                                                                                                                                                    if args.monitor:
                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                                                                                                                                                    elif args.all_live_details:
                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                                                                                                                                                            if not lives:
                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                                                                                                                                                stats_history = {}
                                                                                                                                                                                                                                                                                for m in lives:
                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                                                                                                                                                            import sqlite3
                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                                                                                                                                                            conn.close()
                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                                                                                                                                                    cursor.execute(
                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                                                                                                                                                                                        (league, team)
                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                                                                                                                                                                                    conn.close()
                                                                                                                                                                                                                                                                                                    # Filtrage par side
                                                                                                                                                                                                                                                                                                    filtered = []
                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                                                                                                                                                                                    total = len(filtered)
                                                                                                                                                                                                                                                                                                    start, end = interval
                                                                                                                                                                                                                                                                                                    # Récurrence globale
                                                                                                                                                                                                                                                                                                    avec_but = 0
                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                                                                        except Exception:
                                                                                                                                                                                                                                                                                                            goals, conceded = [], []
                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]le = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]








































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []                                                                                                                                                                                                                                                                                                                                        except Exception:                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                                        try:                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:                                                                                                                                                                                                                                                                                                                                    avec_but = 0                                                                                                                                                                                                                                                                                                                                    # Récurrence globale                                                                                                                                                                                                                                                                                                                                    start, end = interval                                                                                                                                                                                                                                                                                                                                    total = len(filtered)                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))                                                                                                                                                                                                                                                                                                                                            continue                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:                                                                                                                                                                                                                                                                                                                                    filtered = []                                                                                                                                                                                                                                                                                                                                    # Filtrage par side                                                                                                                                                                                                                                                                                                                                    conn.close()                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                    )                                                                                                                                                                                                                                                                                                                                        (league, team)                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",                                                                                                                                                                                                                                                                                                                                    cursor.execute(                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                                    import sqlite3, json                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")                                                                                                                                                                                                                                                                                                                    except Exception as e:                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1                                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2                                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)                                                                                                                                                                                                                                                                                                                            conn.close()                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')                                                                                                                                                                                                                                                                                                                            import sqlite3                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data                                                                                                                                                                                                                                                                                                                        if data:                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])                                                                                                                                                                                                                                                                                                                    try:                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")                                                                                                                                                                                                                                                                                                                for m in lives:                                                                                                                                                                                                                                                                                                                stats_history = {}                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")                                                                                                                                                                                                                                                                                                            else:                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")                                                                                                                                                                                                                                                                                                            if not lives:                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)                                                                                                                                                                                                                                                                                                        else:                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:                                                                                                                                                                                                                                                                                                    elif args.all_live_details:                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)                                                                                                                                                                                                                                                                                                    if args.monitor:                                                                                                                                                                                                                                                                                                        score = recurrence_globale                                                                                                                                                                                                                                                                                                    else:                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2                                                                                                                                                                                                                                                                                                    if total >= 3:                                                                                                                                                                                                                                                                                                    # Score combiné                                                                                                                                                                                                                                                                                                                best_window = window                                                                                                                                                                                                                                                                                                                best_recent = rec                                                                                                                                                                                                                                                                                                            if rec > best_recent:                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []                                                                                                                                                                                                                                                                                                                except Exception:                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []                                                                                                                                                                                                                                                                                                                try:                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:                                                                                                                                                                                                                                                                                                            avec_but_recent = 0                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]                                                                                                                                                                                                                                                                                                        if total >= window:                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:                                                                                                                                                                                                                                                                                                    best_window = 3                                                                                                                                                                                                                                                                                                    best_recent = 0.0                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0                                                                                                                                                                                                                                                                                                            avec_but += 1                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                                                                            avec_but += 1
                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                                                                                                                                                                                    best_recent = 0.0
                                                                                                                                                                                                                                                                                                    best_window = 3
                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:
                                                                                                                                                                                                                                                                                                        if total >= window:
                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]
                                                                                                                                                                                                                                                                                                            avec_but_recent = 0
                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                                                                                except Exception:
                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1
                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                                                                                                                                                                                            if rec > best_recent:
                                                                                                                                                                                                                                                                                                                best_recent = rec
                                                                                                                                                                                                                                                                                                                best_window = window
                                                                                                                                                                                                                                                                                                    # Score combiné
                                                                                                                                                                                                                                                                                                    if total >= 3:
                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                        score = recurrence_globale

                                                                                                                                                                                                                                                                                                    if args.monitor:
                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                                                                                                                                                                                    elif args.all_live_details:
                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                                                                                                                                                                                            if not lives:
                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                                                                                                                                                                                stats_history = {}
                                                                                                                                                                                                                                                                                                                for m in lives:
                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                                                                                                                                                                                            import sqlite3
                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                                                                                                                                                                                            conn.close()
                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                                                                                                                                                                                    cursor.execute(
                                                                                                                                                                                                                                                                                                                                        "SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?",
                                                                                                                                                                                                                                                                                                                                        (league, team)
                                                                                                                                                                                                                                                                                                                                    )
                                                                                                                                                                                                                                                                                                                                    matchs = cursor.fetchall()
                                                                                                                                                                                                                                                                                                                                    conn.close()
                                                                                                                                                                                                                                                                                                                                    # Filtrage par side
                                                                                                                                                                                                                                                                                                                                    filtered = []
                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded, is_home in matchs:
                                                                                                                                                                                                                                                                                                                                        if (side == "HOME" and not is_home) or (side == "AWAY" and is_home):
                                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                        filtered.append((goal_times, goal_times_conceded))
                                                                                                                                                                                                                                                                                                                                    total = len(filtered)
                                                                                                                                                                                                                                                                                                                                    start, end = interval
                                                                                                                                                                                                                                                                                                                                    # Récurrence globale
                                                                                                                                                                                                                                                                                                                                    avec_but = 0
                                                                                                                                                                                                                                                                                                                                    for goal_times, goal_times_conceded in filtered:
                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                            goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                                                                                                            conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                                                                                                        except Exception:
                                                                                                                                                                                                                                                                                                                                            goals, conceded = [], []
                                                                                                                                                                                                                                                                                                                                        buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                                                                                                                        if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                                                                                                            avec_but += 1
                                                                                                                                                                                                                                                                                                                                    recurrence_globale = (avec_but / total) if total > 0 else 0.0
                                                                                                                                                                                                                                                                                                                                    # Récurrence récente (fenêtres 3,4,5)
                                                                                                                                                                                                                                                                                                                                    best_recent = 0.0
                                                                                                                                                                                                                                                                                                                                    best_window = 3
                                                                                                                                                                                                                                                                                                                                    for window in [3,4,5]:
                                                                                                                                                                                                                                                                                                                                        if total >= window:
                                                                                                                                                                                                                                                                                                                                            recent = filtered[-window:]
                                                                                                                                                                                                                                                                                                                                            avec_but_recent = 0
                                                                                                                                                                                                                                                                                                                                            for goal_times, goal_times_conceded in recent:
                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                    goals = json.loads(goal_times) if goal_times else []
                                                                                                                                                                                                                                                                                                                                                    conceded = json.loads(goal_times_conceded) if goal_times_conceded else []
                                                                                                                                                                                                                                                                                                                                                except Exception:
                                                                                                                                                                                                                                                                                                                                                    goals, conceded = [], []
                                                                                                                                                                                                                                                                                                                                                buts_dans_intervalle = [m for m in goals if start <= m <= end] + [m for m in conceded if start <= m <= end]
                                                                                                                                                                                                                                                                                                                                                if len(buts_dans_intervalle) > 0:
                                                                                                                                                                                                                                                                                                                                                    avec_but_recent += 1
                                                                                                                                                                                                                                                                                                                                            rec = avec_but_recent / window
                                                                                                                                                                                                                                                                                                                                            if rec > best_recent:
                                                                                                                                                                                                                                                                                                                                                best_recent = rec
                                                                                                                                                                                                                                                                                                                                                best_window = window
                                                                                                                                                                                                                                                                                                                                    # Score combiné
                                                                                                                                                                                                                                                                                                                                    if total >= 3:
                                                                                                                                                                                                                                                                                                                                        score = (recurrence_globale + best_recent) / 2
                                                                                                                                                                                                                                                                                                                                    else:
                                                                                                                                                                                                                                                                                                                                        score = recurrence_globale

                                                                                                                                                                                                                                                                                                                                    if args.monitor:
                                                                                                                                                                                                                                                                                                                                        monitor_match(args.monitor, interval=args.interval)
                                                                                                                                                                                                                                                                                                                                    elif args.all_live_details:
                                                                                                                                                                                                                                                                                                                                        if SoccerStatsLiveScraper is None:
                                                                                                                                                                                                                                                                                                                                            print("SoccerStatsLiveScraper non disponible. Placez ce fichier à la racine du projet ou installez le module.")
                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                            lives = get_live_matches(args.url, debug=args.debug)
                                                                                                                                                                                                                                                                                                                                            # print(f"[DEBUG] Lives détectés : {lives}")
                                                                                                                                                                                                                                                                                                                                            if not lives:
                                                                                                                                                                                                                                                                                                                                                print("Aucun match live détecté depuis la page principale.")
                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                print("\nDétails complets pour tous les matches live détectés :\n")
                                                                                                                                                                                                                                                                                                                                                scraper = SoccerStatsLiveScraper()
                                                                                                                                                                                                                                                                                                                                                from scoring_detaille import scoring_detaille
                                                                                                                                                                                                                                                                                                                                                from scoring_utils import get_pattern_score, get_saturation_score, compute_momentum
                                                                                                                                                                                                                                                                                                                                                # Historique in-play pour momentum (clé: match_url)
                                                                                                                                                                                                                                                                                                                                                stats_history = {}
                                                                                                                                                                                                                                                                                                                                                for m in lives:
                                                                                                                                                                                                                                                                                                                                                    # print(f"[DEBUG] Traitement match : {m}")
                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                                                                                                                            # Initialisation de l'intervalle AVANT toute utilisation
                                                                                                                                                                                                                                                                                                                                                            interval = (31, 45) if d.get('minute', 0) <= 45 else (75, 120)
                                                                                                                                                                                                                                                                                                                                                            # ...calcul patterns historiques, mt_stats_home, mt_stats_away...
                                                                                                                                                                                                                                                                                                                                                            # Calcul du score live (buts marqués dans l'intervalle en cours)
                                                                                                                                                                                                                                                                                                                                                            score_live = d.get('score_home', 0) + d.get('score_away', 0)
                                                                                                                                                                                                                                                                                                                                                            # Extraction des stats MT1/MT2 pour calcul de la moyenne attendue
                                                                                                                                                                                                                                                                                                                                                            # (on doit recharger les matchs pour chaque équipe)
                                                                                                                                                                                                                                                                                                                                                            import sqlite3
                                                                                                                                                                                                                                                                                                                                                            conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                                                                                                            cursor = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['home_team']))
                                                                                                                                                                                                                                                                                                                                                            matchs_home = [mm for mm in cursor.fetchall() if mm[2]]
                                                                                                                                                                                                                                                                                                                                                            cursor.execute("SELECT goal_times, goal_times_conceded, is_home FROM soccerstats_scraped_matches WHERE league = ? AND team = ?", (m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france', d['away_team']))
                                                                                                                                                                                                                                                                                                                                                            matchs_away = [mm for mm in cursor.fetchall() if not mm[2]]
                                                                                                                                                                                                                                                                                                                                                            conn.close()
                                                                                                                                                                                                                                                                                                                                                            mt_stats_home = compute_mt_goals(matchs_home)
                                                                                                                                                                                                                                                                                                                                                            mt_stats_away = compute_mt_goals(matchs_away)
                                                                                                                                                                                                                                                                                                                                                            if interval == (31, 45):
                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt1_moy'] + mt_stats_away['mt1_moy']) / 2
                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                moyenne_attendue = (mt_stats_home['mt2_moy'] + mt_stats_away['mt2_moy']) / 2
                                                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                                            moyenne_attendue = 1
                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                        print(f"  ❌ Erreur lors de l'extraction : {e}")
                                                                                                                                                                                                                                                                                                                                                        moyenne_attendue = 1
                                                                                                                                                                                                                                                                                                                                                    print("\n================ LIVE MATCH =================")
                                                                                                                                                                                                                                                                                                                                                    league = m['url'].split('league=')[1].split('&')[0] if 'league=' in m['url'] else 'france'
                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                        data = scraper.scrape_match(m['url'])
                                                                                                                                                                                                                                                                                                                                                        if data:
                                                                                                                                                                                                                                                                                                                                                            d = data.to_dict() if hasattr(data, "to_dict") else data
                                                                                                                                                                                                                                                                                                                                                            print(f"URL : {m['url']} | minute : {d.get('minute')} | {d['home_team']} {d['score_home']} – {d['score_away']} {d['away_team']}")
                                                                                                                                                                                                                                                                                                                                                            print("--- PATTERNS HISTORIQUES ---")
                                                                                                                                                                                                                                                                                                                                                            from scoring_utils import get_pattern_score
                                                                                                                                                                                                                                                                                                                                                            # interval déjà défini plus haut
                                                                                                                                                                                                                                                                                                                                                            def get_but_stats(league, team, side, interval):
                                                                                                                                                                                                                                                                                                                                                                def get_pattern_score_details(league, team, side, interval):
                                                                                                                                                                                                                                                                                                                                                                    # Extraction de la récurrence globale, meilleure récurrence récente (fenêtre 3,4,5), et score combiné
                                                                                                                                                                                                                                                                                                                                                                    import sqlite3, json
                                                                                                                                                                                                                                                                                                                                                                    conn = sqlite3.connect('/workspaces/paris-live/football-live-prediction/data/predictions.db')
                                                                                                                                                                                                                                                                                                                                                                    cursor = conn.cursor()
                                                                                                                                                                                                                                                                                                                                                                    cursor.execute(